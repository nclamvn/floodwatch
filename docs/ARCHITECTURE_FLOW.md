# FloodWatch - Data Flow Architecture

> **Current State**: Sprint 1 Complete (Hazard Events)
> **Next Phase**: Sprint 2 (Alert Subscriptions)

---

## ðŸ”„ Current Data Flow (Sprint 1 - âœ… HOÃ€N THÃ€NH)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER BROWSER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  Map Component   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ LocateMeButton   â”‚                     â”‚
â”‚  â”‚  (MapLibre)      â”‚         â”‚ (GPS Tracking)   â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚           â”‚                             â”‚                               â”‚
â”‚           â”‚ Display                     â”‚ Get GPS                       â”‚
â”‚           â”‚ hazards                     â”‚ coords                        â”‚
â”‚           â”‚                             â–¼                               â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚           â”‚                   â”‚ LocationContext â”‚                       â”‚
â”‚           â”‚                   â”‚ (lat, lng)      â”‚                       â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                             â”‚                               â”‚
â”‚           â–¼                             â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â”‚     HazardLayer Component (ðŸ”§ NEXT)       â”‚                         â”‚
â”‚  â”‚  â€¢ Fetch: GET /hazards?lat=..&lng=..      â”‚                         â”‚
â”‚  â”‚  â€¢ Render circles (radius + severity)     â”‚                         â”‚
â”‚  â”‚  â€¢ Popup with event details                â”‚                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚           â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTP Request
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NEXT.JS WEB APP (PORT 3002)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â€¢ Render UI (React components)                                        â”‚
â”‚  â€¢ Proxy API calls to FastAPI backend                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ API Proxy
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FASTAPI BACKEND (PORT 8000)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚              HAZARD EVENTS API (âœ… DONE)              â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  GET /hazards                                        â”‚              â”‚
â”‚  â”‚  â”œâ”€ Query params: lat, lng, radius_km, types,       â”‚              â”‚
â”‚  â”‚  â”‚                severity, active_only             â”‚              â”‚
â”‚  â”‚  â””â”€ Returns: List of hazards + distance             â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  GET /hazards/{id}                                   â”‚              â”‚
â”‚  â”‚  â””â”€ Returns: Single hazard details                  â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  POST /hazards                                       â”‚              â”‚
â”‚  â”‚  â”œâ”€ Body: type, severity, lat, lon, radius_km,      â”‚              â”‚
â”‚  â”‚  â”‚        starts_at, ends_at, source                â”‚              â”‚
â”‚  â”‚  â””â”€ Returns: Created hazard                         â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  PATCH /hazards/{id}                                 â”‚              â”‚
â”‚  â”‚  â””â”€ Update: severity, radius_km, ends_at            â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  DELETE /hazards/{id}                                â”‚              â”‚
â”‚  â”‚  â””â”€ Soft delete hazard                              â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”‚ Uses                                                          â”‚
â”‚         â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚         HazardEventRepository (âœ… DONE)               â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  .get_all(db, hazard_types, severity, lat, lng,     â”‚              â”‚
â”‚  â”‚           radius_km, active_only, sort_by)          â”‚              â”‚
â”‚  â”‚  â†’ PostGIS: ST_DWithin(location, user_point, radius)â”‚              â”‚
â”‚  â”‚  â†’ Returns: (hazards, total, distances)             â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  .get_by_id(db, hazard_id)                          â”‚              â”‚
â”‚  â”‚  .create(db, hazard_data)                           â”‚              â”‚
â”‚  â”‚  .update(db, hazard_id, update_data)                â”‚              â”‚
â”‚  â”‚  .delete(db, hazard_id)                             â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ SQL Queries
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  POSTGRESQL + PostGIS DATABASE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚           hazard_events (âœ… MIGRATED)                 â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ Columns:                                             â”‚              â”‚
â”‚  â”‚  â€¢ id (UUID, PK)                                     â”‚              â”‚
â”‚  â”‚  â€¢ type (ENUM: heavy_rain, flood, dam_release, ...)  â”‚              â”‚
â”‚  â”‚  â€¢ severity (ENUM: info, low, medium, high, critical)â”‚              â”‚
â”‚  â”‚  â€¢ location (GEOGRAPHY Point 4326) â† PostGIS!        â”‚              â”‚
â”‚  â”‚  â€¢ radius_km (FLOAT)                                 â”‚              â”‚
â”‚  â”‚  â€¢ lat, lon (FLOAT, auto-extracted)                  â”‚              â”‚
â”‚  â”‚  â€¢ starts_at, ends_at (TIMESTAMPTZ)                  â”‚              â”‚
â”‚  â”‚  â€¢ source (VARCHAR)                                  â”‚              â”‚
â”‚  â”‚  â€¢ raw_payload (JSONB)                               â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ Indexes:                                             â”‚              â”‚
â”‚  â”‚  â€¢ GIST(location) â† Fast spatial queries             â”‚              â”‚
â”‚  â”‚  â€¢ BTREE(starts_at, ends_at) â† Time filtering        â”‚              â”‚
â”‚  â”‚  â€¢ BTREE(type, severity) â† Type/severity filtering   â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ Sample Query:                                        â”‚              â”‚
â”‚  â”‚  SELECT * FROM hazard_events                         â”‚              â”‚
â”‚  â”‚  WHERE ST_DWithin(                                   â”‚              â”‚
â”‚  â”‚    location::geography,                              â”‚              â”‚
â”‚  â”‚    ST_SetSRID(ST_MakePoint(lng, lat), 4326),         â”‚              â”‚
â”‚  â”‚    radius_km * 1000                                  â”‚              â”‚
â”‚  â”‚  )                                                   â”‚              â”‚
â”‚  â”‚  AND severity IN ('high', 'critical')                â”‚              â”‚
â”‚  â”‚  AND (ends_at IS NULL OR ends_at > NOW())            â”‚              â”‚
â”‚  â”‚  ORDER BY ST_Distance(location, user_point) ASC;     â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                         â”‚
â”‚  Sample Data:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  type  â”‚ severity  â”‚   lat    â”‚   lon    â”‚ radius_kmâ”‚  status  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ flood  â”‚ critical  â”‚ 21.0278  â”‚ 105.8342 â”‚   10     â”‚  active  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸš€ Future Data Flow (Sprint 2 - ALERT SYSTEM)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER BROWSER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  Map Component   â”‚         â”‚ LocateMeButton   â”‚                     â”‚
â”‚  â”‚  + HazardLayer   â”‚         â”‚ (GPS)            â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚           â”‚                             â”‚                               â”‚
â”‚           â”‚                             â–¼                               â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚                   â”‚ ðŸ†• Subscribe Button â”‚                   â”‚
â”‚           â”‚                   â”‚ "ÄÄƒng kÃ½ cáº£nh bÃ¡o"  â”‚                   â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                             â”‚                               â”‚
â”‚           â”‚                             â”‚ Click                         â”‚
â”‚           â”‚                             â–¼                               â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚           â”‚                   â”‚ ðŸ†• SubscriptionDialog       â”‚           â”‚
â”‚           â”‚                   â”‚ â€¢ Select radius (3/5/10 km) â”‚           â”‚
â”‚           â”‚                   â”‚ â€¢ Select severity (â‰¥medium) â”‚           â”‚
â”‚           â”‚                   â”‚ â€¢ Select types (flood, rain)â”‚           â”‚
â”‚           â”‚                   â”‚ â€¢ Enter email               â”‚           â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                             â”‚                               â”‚
â”‚           â”‚                             â”‚ Submit                        â”‚
â”‚           â”‚                             â–¼                               â”‚
â”‚           â”‚                   POST /alerts/subscribe                    â”‚
â”‚           â”‚                   {                                         â”‚
â”‚           â”‚                     email, lat, lng,                        â”‚
â”‚           â”‚                     radius_km, types,                       â”‚
â”‚           â”‚                     min_severity                            â”‚
â”‚           â”‚                   }                                         â”‚
â”‚           â”‚                             â”‚                               â”‚
â”‚           â”‚                             â–¼                               â”‚
â”‚           â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚                   â”‚ ðŸ†• Confirmation Emailâ”‚                   â”‚
â”‚           â”‚                   â”‚ Click to confirm    â”‚                   â”‚
â”‚           â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚ ðŸ†• Alert Banner (In-App)              â”‚                             â”‚
â”‚  â”‚ "âš ï¸ Ngáº­p lá»¥t má»©c cao cÃ¡ch báº¡n 2.3 km" â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FASTAPI BACKEND (PORT 8000)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚           ðŸ†• ALERT SUBSCRIPTIONS API                  â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  POST /alerts/subscribe                              â”‚              â”‚
â”‚  â”‚  â”œâ”€ Body: email, lat, lng, radius_km,                â”‚              â”‚
â”‚  â”‚  â”‚        alert_types, min_severity                 â”‚              â”‚
â”‚  â”‚  â””â”€ Returns: subscription + confirmation_token      â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  GET /alerts/subscriptions/confirm/{token}           â”‚              â”‚
â”‚  â”‚  â””â”€ Confirm email â†’ activate subscription           â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  GET /alerts/subscriptions (auth required)           â”‚              â”‚
â”‚  â”‚  â””â”€ List user's subscriptions                       â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  PATCH /alerts/subscriptions/{id}                    â”‚              â”‚
â”‚  â”‚  â””â”€ Update radius, severity, types                  â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  DELETE /alerts/subscriptions/{id}                   â”‚              â”‚
â”‚  â”‚  â””â”€ Unsubscribe                                     â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  POSTGRESQL + PostGIS DATABASE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚       ðŸ†• alert_subscriptions (Sprint 2)               â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ Columns:                                             â”‚              â”‚
â”‚  â”‚  â€¢ id (UUID, PK)                                     â”‚              â”‚
â”‚  â”‚  â€¢ contact_email (VARCHAR)                           â”‚              â”‚
â”‚  â”‚  â€¢ telegram_chat_id (BIGINT, nullable)               â”‚              â”‚
â”‚  â”‚  â€¢ location (GEOGRAPHY Point) â† User's watch point   â”‚              â”‚
â”‚  â”‚  â€¢ radius_km (FLOAT, default 3)                      â”‚              â”‚
â”‚  â”‚  â€¢ alert_types (hazard_type[], array)                â”‚              â”‚
â”‚  â”‚  â€¢ min_severity (severity_level)                     â”‚              â”‚
â”‚  â”‚  â€¢ notify_via (VARCHAR[], email/telegram/sms)        â”‚              â”‚
â”‚  â”‚  â€¢ is_active (BOOLEAN, default false)                â”‚              â”‚
â”‚  â”‚  â€¢ confirmed (BOOLEAN, default false)                â”‚              â”‚
â”‚  â”‚  â€¢ confirmation_token (VARCHAR)                      â”‚              â”‚
â”‚  â”‚  â€¢ created_at (TIMESTAMPTZ)                          â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ Indexes:                                             â”‚              â”‚
â”‚  â”‚  â€¢ GIST(location) â† Fast spatial matching            â”‚              â”‚
â”‚  â”‚  â€¢ BTREE(is_active, confirmed) â† Active subs only    â”‚              â”‚
â”‚  â”‚  â€¢ BTREE(contact_email) â† User lookup                â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                         â–²                                               â”‚
â”‚                         â”‚                                               â”‚
â”‚                         â”‚ SPATIAL JOIN                                  â”‚
â”‚                         â”‚ (Matching Logic)                              â”‚
â”‚                         â”‚                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚       ðŸ†• alert_notifications (Sprint 2)               â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ Columns:                                             â”‚              â”‚
â”‚  â”‚  â€¢ id (UUID, PK)                                     â”‚              â”‚
â”‚  â”‚  â€¢ subscription_id (UUID, FK)                        â”‚              â”‚
â”‚  â”‚  â€¢ hazard_event_id (UUID, FK)                        â”‚              â”‚
â”‚  â”‚  â€¢ severity (severity_level)                         â”‚              â”‚
â”‚  â”‚  â€¢ distance_km (FLOAT)                               â”‚              â”‚
â”‚  â”‚  â€¢ triggered_at (TIMESTAMPTZ)                        â”‚              â”‚
â”‚  â”‚  â€¢ sent_at (TIMESTAMPTZ)                             â”‚              â”‚
â”‚  â”‚  â€¢ delivery_status (VARCHAR: pending/sent/failed)    â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ Purpose: Log cá»§a má»—i láº§n cáº£nh bÃ¡o Ä‘Æ°á»£c trigger       â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–²
            â”‚
            â”‚ Periodic Query (every 5-10 minutes)
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ðŸ†• ALERT ENGINE WORKER (Sprint 2)                          â”‚
â”‚                   (Background Service)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚         Matching Algorithm (PostGIS)                 â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  1. Fetch active hazards:                           â”‚              â”‚
â”‚  â”‚     SELECT * FROM hazard_events                      â”‚              â”‚
â”‚  â”‚     WHERE severity >= 'medium'                       â”‚              â”‚
â”‚  â”‚       AND (ends_at IS NULL OR ends_at > NOW())       â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  2. For each hazard, find matching subscriptions:   â”‚              â”‚
â”‚  â”‚     SELECT * FROM alert_subscriptions                â”‚              â”‚
â”‚  â”‚     WHERE is_active = true                           â”‚              â”‚
â”‚  â”‚       AND confirmed = true                           â”‚              â”‚
â”‚  â”‚       AND hazard.type = ANY(alert_types)             â”‚              â”‚
â”‚  â”‚       AND hazard.severity >= min_severity            â”‚              â”‚
â”‚  â”‚       AND ST_DWithin(                                â”‚              â”‚
â”‚  â”‚           subscription.location::geography,          â”‚              â”‚
â”‚  â”‚           hazard.location::geography,                â”‚              â”‚
â”‚  â”‚           subscription.radius_km * 1000              â”‚              â”‚
â”‚  â”‚       )                                              â”‚              â”‚
â”‚  â”‚       AND NOT EXISTS (                               â”‚              â”‚
â”‚  â”‚         -- Prevent duplicate notifications           â”‚              â”‚
â”‚  â”‚         SELECT 1 FROM alert_notifications            â”‚              â”‚
â”‚  â”‚         WHERE subscription_id = ...                  â”‚              â”‚
â”‚  â”‚           AND hazard_event_id = ...                  â”‚              â”‚
â”‚  â”‚       )                                              â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  3. Create alert_notifications records               â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚  4. Send notifications via:                          â”‚              â”‚
â”‚  â”‚     â€¢ Email (Resend API)                             â”‚              â”‚
â”‚  â”‚     â€¢ Telegram (Bot API)                             â”‚              â”‚
â”‚  â”‚     â€¢ In-app (WebSocket push - future)               â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                         â”‚
â”‚  Scheduler: APScheduler (or Celery + Redis for production)             â”‚
â”‚  Frequency: Every 5-10 minutes                                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ Send Email
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ðŸ†• EMAIL SERVICE (Resend)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Email Template:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Subject: âš ï¸ Cáº£nh bÃ¡o: Ngáº­p lá»¥t gáº§n vá»‹ trÃ­ cá»§a báº¡n    â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ Xin chÃ o,                                            â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ CÃ³ sá»± kiá»‡n thiÃªn tai gáº§n báº¡n:                        â”‚              â”‚
â”‚  â”‚ â€¢ Loáº¡i: Ngáº­p lá»¥t                                     â”‚              â”‚
â”‚  â”‚ â€¢ Má»©c Ä‘á»™: Cao (High)                                 â”‚              â”‚
â”‚  â”‚ â€¢ Khoáº£ng cÃ¡ch: 2.3 km                                â”‚              â”‚
â”‚  â”‚ â€¢ Thá»i gian: 19/11/2025 14:00 - 20/11/2025 02:00     â”‚              â”‚
â”‚  â”‚ â€¢ Nguá»“n: KTTV                                        â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â”‚ [Xem trÃªn báº£n Ä‘á»“] [Há»§y Ä‘Äƒng kÃ½]                      â”‚              â”‚
â”‚  â”‚                                                      â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”— Data Relationships (Entity-Relationship)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ hazard_events   â”‚
â”‚ (Táº§ng 1)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ alert_notificationsâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ alert_subscriptions â”‚
â”‚ (Táº§ng 3)           â”‚   N:1   â”‚ (Táº§ng 3)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â”‚ 1:N                          â”‚ 1:N
         â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notification_log   â”‚         â”‚ (User table - future)â”‚
â”‚ (Delivery details) â”‚         â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Matching Query** (Core of Alert Engine):
```sql
-- Find all subscriptions that should be notified about a hazard
SELECT
  sub.id AS subscription_id,
  sub.contact_email,
  haz.id AS hazard_id,
  haz.type,
  haz.severity,
  ST_Distance(
    sub.location::geography,
    haz.location::geography
  ) / 1000 AS distance_km
FROM alert_subscriptions sub
CROSS JOIN hazard_events haz
WHERE
  -- Subscription active and confirmed
  sub.is_active = true
  AND sub.confirmed = true

  -- Hazard type matches subscription preferences
  AND haz.type = ANY(sub.alert_types)

  -- Hazard severity meets minimum threshold
  AND haz.severity::text >= sub.min_severity::text

  -- Spatial match: hazard within user's watch radius
  AND ST_DWithin(
    sub.location::geography,
    haz.location::geography,
    sub.radius_km * 1000  -- Convert km to meters
  )

  -- Event is active or upcoming
  AND (haz.ends_at IS NULL OR haz.ends_at > NOW())
  AND haz.starts_at < NOW() + INTERVAL '6 hours'

  -- Prevent duplicate notifications
  AND NOT EXISTS (
    SELECT 1 FROM alert_notifications an
    WHERE an.subscription_id = sub.id
      AND an.hazard_event_id = haz.id
  );
```

---

## ðŸ—ï¸ Infrastructure Components

### Current (Sprint 1)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚â”€â”€â”€â”€â–¶â”‚   Next.js    â”‚â”€â”€â”€â”€â–¶â”‚   FastAPI    â”‚
â”‚   (User)     â”‚     â”‚  (Port 3002) â”‚     â”‚  (Port 8000) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â–¼
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚  PostgreSQL  â”‚
                                         â”‚  + PostGIS   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Future (Sprint 2)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚â”€â”€â”€â”€â–¶â”‚   Next.js    â”‚â”€â”€â”€â”€â–¶â”‚   FastAPI    â”‚
â”‚   (User)     â”‚     â”‚  (Port 3002) â”‚     â”‚  (Port 8000) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                     â”‚                            â”‚
                     â–¼                            â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Alert Worker â”‚            â”‚  PostgreSQL  â”‚
            â”‚ (Background) â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  + PostGIS   â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Send Notifications
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Resend API   â”‚
            â”‚ (Email)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Production (Future)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚â”€â”€â”€â”€â–¶â”‚   Next.js    â”‚â”€â”€â”€â”€â–¶â”‚   FastAPI    â”‚
â”‚   (Users)    â”‚     â”‚  (Vercel)    â”‚     â”‚  (Cloud Run) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                            â”‚        â”‚
                     â–¼                            â–¼        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚ Celery +     â”‚            â”‚ Cloud SQL    â”‚  â”‚
            â”‚ Redis Queue  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ PostgreSQL   â”‚  â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ + PostGIS    â”‚  â”‚
                   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                   â”‚                                      â”‚
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ Send via
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Resend (Email)
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Telegram Bot API
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ WebSocket (In-app push)
```

---

## ðŸ“ˆ Scaling Considerations

### Query Performance (PostGIS)
- **Current**: 1 hazard + 1 subscription â†’ 0.5ms query time
- **At scale**: 100 hazards + 10,000 subscriptions â†’ ?

**Optimization strategies**:
1. âœ… GIST indexes on geography columns (already done)
2. Materialized views for frequent queries
3. Partition `alert_notifications` by month
4. Read replicas for reporting

### Worker Scalability
- **MVP**: Single Python process, APScheduler
- **Production**: Celery workers + Redis queue
  - Horizontal scaling: Add more worker containers
  - Job distribution: Redis as message broker

---

**Last Updated**: 2025-11-19
**Version**: 1.0
**Status**: âœ… Current Flow Complete | ðŸ”§ Alert System Architecture Ready
