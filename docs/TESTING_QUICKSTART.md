# FloodWatch UI/UX Testing Quick Start

**Lá»™ trÃ¬nh:** A (Local) â†’ B (Preview Server) â†’ C (Go-Live)

---

## ðŸš€ PHASE A: Local Staging (15 min)

### Setup Commands:

```bash
cd /Users/mac/floodwatch

# 1. Create .env.local
cp .env.prod.example .env.local

# 2. Minimal config (edit MAPBOX_TOKEN line 21)
cat > .env.local << 'EOF'
DEBUG=true
SECRET_KEY=local-dev-secret-key-insecure
ADMIN_TOKEN=local-admin-token-insecure

POSTGRES_USER=floodwatch_dev
POSTGRES_PASSWORD=dev_password_123
POSTGRES_DB=floodwatch_dev
DATABASE_URL=postgresql+psycopg://floodwatch_dev:dev_password_123@db:5432/floodwatch_dev

API_TITLE=FloodWatch API (Local Dev)
API_VERSION=4.0.0
CORS_ORIGINS=http://localhost:3000,http://localhost:3001

NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_MAPBOX_TOKEN=YOUR_MAPBOX_TOKEN_HERE

CLOUDINARY_CLOUD_NAME=demo
CLOUDINARY_API_KEY=123456789
CLOUDINARY_API_SECRET=abcdefghijklmnop

ENABLE_PII_SCRUBBING=true
ALLOW_HTTP=true
EOF

# 3. Add real Mapbox token
nano .env.local  # Replace YOUR_MAPBOX_TOKEN_HERE

# 4. Bring up stack
docker compose up -d

# 5. Wait and check
sleep 30
docker compose ps

# 6. Migrations
docker compose exec api alembic upgrade head

# 7. Verify
curl -s http://localhost:8000/health | jq .
docker compose exec web printenv | grep NEXT_PUBLIC_API_URL
```

### Gate A Checklist:

```
[ ] http://localhost:3000/map loads with Mapbox tiles
[ ] Markers appear on map
[ ] Click marker â†’ Bottom sheet opens
[ ] Filter by province works
[ ] Filter by severity works
[ ] http://localhost:3000/lite loads (text-only)
[ ] Console has NO red errors
[ ] Mobile responsive (DevTools)
[ ] curl -s http://localhost:8000/health returns {"status":"ok"}
[ ] curl -s "http://localhost:3000/reports/export?format=csv&since=24h" works
```

**Screenshots to capture:**
1. `/map` with markers
2. Bottom sheet open
3. Console (no errors)
4. `/lite` view

---

## ðŸ”’ PHASE B: Preview Server (30 min)

### On Server:

```bash
ssh user@YOUR_SERVER_IP
cd /opt/floodwatch

# Generate secrets
./infra/scripts/generate_secrets.sh

# Fill credentials
nano .env.prod  # Add MAPBOX_TOKEN, CLOUDINARY_*

# Deploy
./infra/scripts/deploy_production.sh

# Get IP
echo "Server IP: $(curl -s ifconfig.me)"
```

### On Your Mac:

```bash
# Add to hosts (replace A.B.C.D with server IP)
echo "A.B.C.D floodwatch.vn api.floodwatch.vn" | sudo tee -a /etc/hosts

# Test
open https://floodwatch.vn/map
open https://floodwatch.vn/lite
curl https://floodwatch.vn/health

# Run smoke tests (on server)
ssh user@YOUR_SERVER_IP
cd /opt/floodwatch
export API_KEY="<from_deploy_output>"
export ADMIN_TOKEN="<from_.env.prod>"
./infra/scripts/smoke_test.sh  # Expect 7/7 PASS
```

### Gate B Checklist:

```
[ ] Smoke test 7/7 PASS
[ ] CSP STRICT check PASS (in smoke test output)
[ ] No CSP violations in browser console
[ ] SSL certificate valid (Let's Encrypt)
[ ] Mapbox tiles load correctly
[ ] Cloudinary images load (if used)
[ ] p95 latency < 150ms (optional k6 test)
[ ] All security headers present (HSTS, CSP, XFO, XCTO)
```

### Cleanup (after testing):

```bash
# Remove hosts entry
sudo sed -i '' '/floodwatch.vn/d' /etc/hosts  # macOS
```

---

## ðŸŒ PHASE C: Go-Live (60-90 min)

**Follow:** `docs/RUN_ORDER.md`

**Key milestones:**
- T-30': Send pre-cutover comms (use `docs/COMMS_TEMPLATES.md` #1)
- H-0: Run `./infra/scripts/deploy_production.sh`
- H+5': Web accessible â†’ Start UI/UX testing
- H+10': DB ready â†’ Test API/data features
- H+20': Smoke tests complete â†’ Send success comms (#3)

**Test URLs:**
- https://floodwatch.vn/map
- https://floodwatch.vn/lite
- https://floodwatch.vn/health
- https://api.floodwatch.vn/docs

---

## ðŸ“Š Placeholders to Fill (Before B/C)

**In `.env.prod` (Phase B/C):**
- `NEXT_PUBLIC_MAPBOX_TOKEN` (required)
- `CLOUDINARY_*` (if using images)
- `ADMIN_TOKEN` (generated by script)
- `SECRET_KEY` (generated by script)

**In `docs/COMMS_TEMPLATES.md` (Phase C):**
- `{{WINDOW_START}}` / `{{WINDOW_END}}` / `{{DURATION_MIN}}`
- `{{COMMS_OWNER_NAME}}` / `{{DRIVER}}` / `{{DECIDER}}` / `{{SCRIBE}}`
- `{{OPS_DASH_URL}}` / `{{METRICS_URL}}` / `{{SLACK_INCIDENT_CHANNEL}}`
- `{{HOTLINE}}`

---

## ðŸ†˜ Troubleshooting

**Port conflicts:**
```bash
lsof -i :3000 -i :8000 -i :5432
# Kill processes or change ports
```

**Map not loading tiles:**
- Check console for "Unauthorized" â†’ Mapbox token invalid
- Check CSP errors â†’ Expected in Phase A (HTTP), fixed in Phase B (HTTPS)

**API not connecting:**
```bash
docker compose exec web printenv | grep NEXT_PUBLIC
# Should be: NEXT_PUBLIC_API_URL=http://localhost:8000 (Phase A)
```

**Smoke test fails:**
```bash
# Check which test failed
./infra/scripts/smoke_test.sh
# Common issues:
# - 401: API_KEY or ADMIN_TOKEN wrong
# - 503: Services not ready, wait 30s and retry
# - CSP: Check security_headers.conf included in nginx
```

---

## ðŸ“ž Support

- Documentation: `infra/DEPLOYMENT_PACKAGE_README.md`
- Timeline: `docs/RUN_ORDER.md`
- Rollback: `infra/ROLLBACK_PLAYBOOK.md`
- Contact: ops@floodwatch.vn

---

**Version:** 1.0
**Last updated:** 2025-11-02
